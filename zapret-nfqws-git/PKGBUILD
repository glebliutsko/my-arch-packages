_pkgname=my-zapret-nfqws
pkgname=${_pkgname}-git
pkgver=r493.aa231a1
pkgrel=1
pkgdesc='Bypass deep packet inspection.'
arch=('any')
url='https://github.com/bol-van/zapret'
license=('GPL')
depends=('systemd' 'curl' 'libnetfilter_queue')
makedepends=('git')

source=("$_pkgname::git+https://github.com/bol-van/zapret.git"
        'zapret-nfqws-update-blocklist.sh'
        'zapret-nfqws.service'
        'zapret-nfqws-update-blocklist.service'
        'zapret-nfqws-update-blocklist.timer'
        'zapret-user-hosts.txt'
        'config')
sha256sums=('SKIP'
            '413753e7cd5a2c08ae113648cdaca594bfbc5dc17cfc8c112c46b5b6cb331536'
            'e953b93fa632ac98e471f736461174dbd581d885c59bfdb544ce3ed61a6f70ee'
            '54e28550b455ebea5e2a253c9266776061a49b96e23462cd3da6c7b6a39de3b1'
            '9c8872fc11d4ba434265ee77ddf58e4bfb682f28f77293ff84607590d6c496c7'
            'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
            '3a89773bcea26b4d062a0c1480c940b3bcd39789b3e9534f2a194b0f3d84c9da')

install=zapret-nfqws.install

backup=('etc/zapret-nfqws/zapret-user-hosts.txt'
        'etc/zapret-nfqws/config')

pkgver() {
    cd "$_pkgname"
    echo "r$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
}

build() {
    cd "$_pkgname"
    make
}

package() {
    mkdir -p -m 755 "$pkgdir/var/lib/zapret-nfqws"
    
    install -Dm 644 "$srcdir/zapret-nfqws.service" "$pkgdir/usr/lib/systemd/system/zapret-nfqws.service"
    install -Dm 644 "$srcdir/zapret-nfqws-update-blocklist.service" "$pkgdir/usr/lib/systemd/system/zapret-nfqws-update-blocklist.service"
    install -Dm 644 "$srcdir/zapret-nfqws-update-blocklist.timer" "$pkgdir/usr/lib/systemd/system/zapret-nfqws-update-blocklist.timer"

    install -Dm 644 "$srcdir/zapret-user-hosts.txt" "$pkgdir/etc/zapret-nfqws/zapret-user-hosts.txt"
    install -Dm 644 "$srcdir/config" "$pkgdir/etc/zapret-nfqws/config"

    install -Dm 755 "$srcdir/$_pkgname/binaries/my/nfqws" "$pkgdir/usr/bin/zapret-nfqws"
    install -Dm 755 "$srcdir/zapret-nfqws-update-blocklist.sh" "$pkgdir/usr/lib/zapret-nfqws-update-blocklist"
}
